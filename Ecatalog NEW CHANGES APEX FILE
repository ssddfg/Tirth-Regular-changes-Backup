public with sharing class EcatalogueConfigController {

    @AuraEnabled(cacheable=true)
    public static String getEcatalogueUrl() {
        String finalUrl = null;

        try {
            // Get Config Metadata
            Ecatalogue_Config__mdt config = [
                SELECT Base_URL__c 
                FROM Ecatalogue_Config__mdt 
                LIMIT 1
            ];
            if (config == null || String.isBlank(config.Base_URL__c)) {
                throw new AuraHandledException('Base URL not configured.');
            }

            // Get dealer code
            User u = [
                SELECT Id, Contact.Account.Customer_Number__c 
                FROM User 
                WHERE Id = :UserInfo.getUserId() 
                LIMIT 1
            ];

			
            String dealerCode = (u.Contact != null && u.Contact.Account != null) ? 
                                 u.Contact.Account.Customer_Number__c : null;

			system.debug('dealerCode'+dealerCode);			

            /*if (String.isBlank(dealerCode)) {
                throw new AuraHandledException('Dealer code missing for current user.');
            }*/

			  // ðŸ”¹ Salesforce INTERNAL user â†’ Direct open (NEW LOGIC)
            if (String.isBlank(dealerCode)) {
                System.debug('Internal Salesforce User - Opening eCatalogue without SSO');
                return config.Base_URL__c;
            }

            // Generate token using your class
            String dealerCodeToken = SSOTokenGenerator.generateSSOKey(dealerCode);
			system.debug('dealerCodeToken'+dealerCodeToken);			

			//finalUrl='https://ecatalogueuat.shaktiman.co.in/index?token=6I3HJPf%2FG7xezR54IjUEg9FVcNsnseT1FyiX9yCPReI%3D';

            // Build final URL
                finalUrl = config.Base_URL__c + '/index?token=' + dealerCodeToken;
			
			system.debug('dealerCodeToken'+finalUrl);


        } catch (AuraHandledException ahe) {
            throw ahe;
        } catch (Exception e) {
            throw new AuraHandledException('Error generating URL: ' + e.getMessage());
        }

        return finalUrl;
    }
}
