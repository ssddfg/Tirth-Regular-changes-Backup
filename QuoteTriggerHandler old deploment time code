/**
 * @description: handler class of Quote trigger for Creating Line Items and Making the Opportunity Stage to closed Won
 * @date: NA
 * @CreatedDate: 21 Feb, 2025
 * @author: Swetha S
 * ********/
public class QuoteTriggerHandler extends TriggerHandler {




    public class MyCustomException extends Exception{}
    private List<Quote> newRecords;
    private Map<Id, Quote> newRecordsMap;
    private Map<Id, Quote> oldMap;


	
    
    public quoteTriggerHandler() {
        System.debug('Inside Trigger');
        this.newRecords = Trigger.new;
        this.newRecordsMap = (Map<Id, Quote>) Trigger.newMap;
        
         if (Trigger.isUpdate || Trigger.isDelete) {
            this.oldMap = (Map<Id, Quote>) Trigger.oldMap; // ‚úÖ makes oldMap available
        }
    }

    public override void beforeInsert() {
        System.debug('Inside before insert of Quote');
        
        //checkRateContractStatus(this.newRecords);
        
        handleBankDetails(this.newRecords);
        setIncoTermLocationFromAccount(this.newRecords);
        handleExporterAddress(this.newRecords);
        setBillAndShipToFromAccount(this.newRecords, null); // ‚úÖ added

		
    // üîπ Set Grand Total in Words
    setGrandTotalInWords(this.newRecords);

	//Billind Addre ACCOunt to Quote
	//setBillAndShipToFromAccount1(this.newRecords);

	//BILL to Party Name 
	 populateShipToPartyAndShippingName(newRecords, null);

	//Combined Address
	setCombinedAddress(this.newRecords);

	//Buyer Combined Address
	setBuyerCombinedAddress(this.newRecords, null);

    }
/*public override void beforeUpdate() {
    System.debug('Inside before update of Quote');
    handleBankDetails(this.newRecords);
    handleExporterAddress(this.newRecords);
}*/
public override void beforeUpdate() {

	setCombinedAddress(this.newRecords);
	
	setBuyerCombinedAddress(this.newRecords, this.oldMap);
	
    System.debug('Inside before update of Quote');
    
     //checkRateContractStatus(this.newRecords);

    // 1Ô∏è‚É£ General updates for all records
    handleExporterAddress(this.newRecords); 
    setIncoTermLocationFromAccount(this.newRecords);
    setBillAndShipToFromAccount(this.newRecords, this.oldMap); // ‚úÖ added

    // 2Ô∏è‚É£ Only update bank details if Bank__c has changed
    /* SOQL Qeury Hit 100 OLD working code

for (Integer i = 0; i < newRecords.size(); i++) {
        Quote newQ = newRecords[i];
        Quote oldQ = (Quote) Trigger.old[i];

		 

        if (newQ.Bank__c != oldQ.Bank__c) {
            handleBankDetails(new List<Quote>{newQ});
        }
    }*/

// 2Ô∏è‚É£ Only update bank details if Bank__c has changed (‚úÖ BULK SAFE)----NEW Code
    List<Quote> bankChangedQuotes = new List<Quote>();
 for (Integer i = 0; i < newRecords.size(); i++) {
        Quote newQ = newRecords[i];
        Quote oldQ = (Quote) Trigger.old[i];

        if (newQ.Bank__c != oldQ.Bank__c) {
            bankChangedQuotes.add(newQ);
        }
    }

    if (!bankChangedQuotes.isEmpty()) {
        handleBankDetails(bankChangedQuotes);
    }

	 // üîπ Set Grand Total in Words
    setGrandTotalInWords(this.newRecords);

	//setBillAndShipToFromAccount1(this.newRecords);
	
	//BILL to Party name Update
	 populateShipToPartyAndShippingName(newRecords, oldMap);
	
}

    // Need to discuss  - Nathan
    // public override void afterDelete(){
    //     Set<Id> oppIds = new Set<Id>();
    //     for(Quote q : Trigger.old){
    //         if(q.Status != 'Accepted')
    //             oppIds.add(q.OpportunityId);
            
    //         List<Opportunity> oppList = [SELECT Id FROM Opportunity WHERE Id In : oppIds];
    //         for(Opportunity opp : oppList){
    //             opp.IsQuoteAccepted__c  = false;
    //         }

    //         Update oppList;
    //     }
        
    // }

    // public override void afterInsert(){
    //     Set<Id> oppIds = new Set<Id>();
    //     List<QuoteLineItem> qliList = new List<QuoteLineItem>();
        
    //     // Collect all related Opportunity IDs from the new Quotes
    //     for (Quote q : newRecords) {
    //         if (q.OpportunityId != null) {
    //             oppIds.add(q.OpportunityId);
    //         }
    //     }
        
    //     Map<Id, List<OpportunityLineItem>> mapOppIdWithOppProducts = new Map<Id, List<OpportunityLineItem>>();
    //     for (OpportunityLineItem oli : [SELECT Id, OpportunityId, Product2Id, Quantity, UnitPrice, Discount, Description , PricebookEntryId,Application_Name__c,Product_Group_Name__c,Solution_Name__c,Series_Name__c,Logistics_Instruction__c,Manufacturing_Instruction__c,Additional_Inspection__c
    //                                 FROM OpportunityLineItem 
    //                                 WHERE OpportunityId IN :oppIds]) {
    //         if (!mapOppIdWithOppProducts.containsKey(oli.OpportunityId)) {
    //             mapOppIdWithOppProducts.put(oli.OpportunityId, new List<OpportunityLineItem>());
    //         }
    //         mapOppIdWithOppProducts.get(oli.OpportunityId).add(oli);
    //     }
        
    //     for (Quote q : newRecords) {
    //         if (q.OpportunityId != null && mapOppIdWithOppProducts.containsKey(q.OpportunityId)) {
    //             for (OpportunityLineItem oli : mapOppIdWithOppProducts.get(q.OpportunityId)) {
    //                 QuoteLineItem qli = new QuoteLineItem(
    //                     QuoteId = q.Id,
    //                 Product2Id = oli.Product2Id,
    //                 Quantity = oli.Quantity,
    //                 UnitPrice = oli.UnitPrice,
    //                 PricebookEntryId = oli.PricebookEntryId,
    //                 Discount = oli.Discount,
    //                 Description = oli.Description,
    //                 Additional_Inspection__c = oli.Additional_Inspection__c,
    //                 Logistics_Instruction__c = oli.Logistics_Instruction__c,
    //                 Manufacturing_Instruction__c = oli.Manufacturing_Instruction__c,
    //                 Application_Name__c = oli.Application_Name__c,
    //                 Product_Group_Name__c=oli.Product_Group_Name__c,
    //                 Solution_Name__c=oli.Solution_Name__c,
    //                 Series_Name__c=oli.Series_Name__c
                        
    //                 );
    //                 qliList.add(qli);
    //             }
    //         }
    //     }
        
    //     if (!qliList.isEmpty()) {
    //         insert qliList;
    //     }
    //     for (Quote q : newRecords) {
    //     if (q.OpportunityId != null) {
    //         try {
    //             OpportunitySchemePopupHelpe.applyOpportunitySchemeToQuote(q.Id);
    //         } catch (Exception e) {
    //             System.debug('Failed to map scheme fields to quote ' + q.Id + ': ' + e.getMessage());
    //         }
    //     }
    // }
    // }







public override void afterInsert() {
 
    System.debug('Executing After Insert');
 
    Set<Id> oppIds = new Set<Id>();
    Set<Id> accIds = new Set<Id>();
 
    for (Quote q : newRecords) {
        if (q.OpportunityId != null) oppIds.add(q.OpportunityId);
    }
    if (oppIds.isEmpty()) return;
 
    Map<Id, Opportunity> oppMap = new Map<Id, Opportunity>(
        [SELECT Id, AccountId FROM Opportunity WHERE Id IN :oppIds]
    );
 
    for (Opportunity opp : oppMap.values()) {
        if (opp.AccountId != null) accIds.add(opp.AccountId);
    }
 
    // ===============================
    // Opportunity Line Items
    // ===============================
    Map<Id, List<OpportunityLineItem>> oppIdVsOlis = new Map<Id, List<OpportunityLineItem>>();
    for (OpportunityLineItem oli : [
        SELECT Id, OpportunityId, Product2Id, Quantity, UnitPrice, Discount,
               Description, PricebookEntryId,
               Application_Name__c, Product_Group_Name__c, Solution_Name__c,
               Series_Name__c, Logistics_Instruction__c, Manufacturing_Instruction__c,
               Additional_Inspection__c, Alternate_Product_Name__c,
               Alternate_Product_Model__c, Parent_Product__c
        FROM OpportunityLineItem
        WHERE OpportunityId IN :oppIds
    ]) {
        if (!oppIdVsOlis.containsKey(oli.OpportunityId)) {
            oppIdVsOlis.put(oli.OpportunityId, new List<OpportunityLineItem>());
        }
        oppIdVsOlis.get(oli.OpportunityId).add(oli);
    }
 
    Date quoteDate = Date.today();
 
    // ===============================
    // Rate Contracts (valid + approved)
    // ===============================
    List<Rate_Contract__c> rcList = [
        SELECT Id, Account__c, INCO_Terms__c, Start_Date__c, End_Date__c, CreatedDate
        FROM Rate_Contract__c
        WHERE Account__c IN :accIds
          AND Is_Active__c = true
          AND Rate_Contract_Approved__c = 'Approved'
          AND Start_Date__c <= :quoteDate
          AND End_Date__c >= :quoteDate
        ORDER BY CreatedDate DESC
    ];
 
    Map<String, List<Rate_Contract__c>> rcGroupMap = new Map<String, List<Rate_Contract__c>>();
    Set<Id> rcIds = new Set<Id>();
 
    for (Rate_Contract__c rc : rcList) {
        String key = rc.Account__c + '-' + rc.INCO_Terms__c;
        if (!rcGroupMap.containsKey(key)) {
            rcGroupMap.put(key, new List<Rate_Contract__c>());
        }
        rcGroupMap.get(key).add(rc);
        rcIds.add(rc.Id);
    }
 
    // ===============================
    // RC Line Items (RC ‚Üí Product)
    // ===============================
    Map<Id, Map<Id, Rate_Contract_Line_Item__c>> rcProductMap = new Map<Id, Map<Id, Rate_Contract_Line_Item__c>>();
    for (Rate_Contract_Line_Item__c rcLi : [
        SELECT Id, Rate_Contract__c, Product__c, Offer_Price_INCO__c
        FROM Rate_Contract_Line_Item__c
        WHERE Rate_Contract__c IN :rcIds
    ]) {
        if (!rcProductMap.containsKey(rcLi.Rate_Contract__c)) {
            rcProductMap.put(rcLi.Rate_Contract__c, new Map<Id, Rate_Contract_Line_Item__c>());
        }
        rcProductMap.get(rcLi.Rate_Contract__c).put(rcLi.Product__c, rcLi);
    }
 
    // ===============================
    // Create Quote Line Items
    // ===============================
    List<QuoteLineItem> qliToInsert = new List<QuoteLineItem>();
    Map<Id, Integer> oliIdToIndex = new Map<Id, Integer>();
 
    for (Quote q : newRecords) {
 
        List<OpportunityLineItem> olis = oppIdVsOlis.get(q.OpportunityId);
        if (olis == null) continue;
 
        String rcKey = oppMap.get(q.OpportunityId).AccountId + '-' + q.INCO_Terms__c;
        List<Rate_Contract__c> rcCandidates = rcGroupMap.get(rcKey);
 
        for (OpportunityLineItem oli : olis) {
 
            Rate_Contract_Line_Item__c matchedRcLi;
 
            if (rcCandidates != null) {
                for (Rate_Contract__c rc : rcCandidates) {
                    if (rcProductMap.containsKey(rc.Id)
                        && rcProductMap.get(rc.Id).containsKey(oli.Product2Id)) {
 
                        matchedRcLi = rcProductMap.get(rc.Id).get(oli.Product2Id);
                        break; // latest RC wins
                    }
                }
            }
 
            QuoteLineItem qli = new QuoteLineItem(
                QuoteId = q.Id,
                Product2Id = oli.Product2Id,
                Quantity = oli.Quantity,
                PricebookEntryId = oli.PricebookEntryId,
                Discount = oli.Discount,
                Description = oli.Description,
                Additional_Inspection__c = oli.Additional_Inspection__c,
                Logistics_Instruction__c = oli.Logistics_Instruction__c,
                Manufacturing_Instruction__c = oli.Manufacturing_Instruction__c,
                Application_Name__c = oli.Application_Name__c,
                Product_Group_Name__c = oli.Product_Group_Name__c,
                Solution_Name__c = oli.Solution_Name__c,
                Series_Name__c = oli.Series_Name__c,
                Alternate_Product_Name__c = oli.Alternate_Product_Name__c,
                Alternate_Product_Model__c = oli.Alternate_Product_Model__c
            );
 
            if (matchedRcLi != null && matchedRcLi.Offer_Price_INCO__c != null) {
                qli.UnitPrice = matchedRcLi.Offer_Price_INCO__c;
                qli.From_Rate_Contract__c = true;
            } else {
                qli.UnitPrice = oli.UnitPrice;   // ‚úÖ fallback
                qli.From_Rate_Contract__c = false;
            }
 
            oliIdToIndex.put(oli.Id, qliToInsert.size());
            qliToInsert.add(qli);
        }
    }
 
    if (!qliToInsert.isEmpty()) insert qliToInsert;
 
    // ===============================
    // Parent‚ÄìChild QLI Mapping
    // ===============================
    List<QuoteLineItem> qliToUpdate = new List<QuoteLineItem>();
 
    for (Quote q : newRecords) {
        List<OpportunityLineItem> olis = oppIdVsOlis.get(q.OpportunityId);
        if (olis == null) continue;
 
        for (OpportunityLineItem oli : olis) {
            if (oli.Parent_Product__c != null
                && oliIdToIndex.containsKey(oli.Parent_Product__c)) {
 
                Integer childIdx = oliIdToIndex.get(oli.Id);
                Integer parentIdx = oliIdToIndex.get(oli.Parent_Product__c);
 
                if (childIdx != null && parentIdx != null) {
                    qliToInsert[childIdx].Parent_Quote_Line_Item__c =
                        qliToInsert[parentIdx].Id;
                    qliToUpdate.add(qliToInsert[childIdx]);
                }
            }
        }
    }
 
    if (!qliToUpdate.isEmpty()) update qliToUpdate;
}










    
    // public override void afterUpdate() {
    //     Set<Id> oppIds = new Set<Id>();
    //     List<Quote> oldRecords = (List<Quote>) Trigger.old;
    //     Map<Id, Quote> oldMap = new Map<Id, Quote>(oldRecords);

        
    //     // for (Quote q : newRecords) {
    //     //     if (q.Status == 'Accepted' && q.OpportunityId != null) {
    //     //         oppIds.add(q.OpportunityId);
    //     //     }
    //     // }
    //     for (Quote q : newRecords) {
    //         // Check if the status changed to 'Accepted'
    //         if (q.Status == 'Accepted' && oldMap.get(q.Id).Status != 'Accepted' && q.OpportunityId != null) {
    //             oppIds.add(q.OpportunityId);
    //         }
    //     }

        
    //     if (oppIds.isEmpty()) {
    //         return;
    //     }
        
    //     List<Opportunity> oppList = [SELECT Id, StageName FROM Opportunity WHERE Id IN :oppIds];
        
    //     for (Opportunity opp : oppList) {
    //         opp.IsQuoteAccepted__c = TRUE;
    //     }
        
    //     if (!oppList.isEmpty()) {
    //         update oppList;
    //     }
    // }

   
/*   OLD Working Code
public override void afterUpdate() {
        Set<Id> rejectedOppIds = new Set<Id>();
        Set<Id> oppIds = new Set<Id>();


        for(Quote q : newRecords){
            if(q.Status == 'Rejected' || q.Status == 'Denied (Internal)'){
                rejectedOppIds.add(q.OpportunityId);
            } else {
                oppIds.add(q.OpportunityId);
            }
        }

        List<Opportunity> rejectedOpps = [SELECT Id, IsQuoteAccepted__c FROM Opportunity WHERE Id In: rejectedOppIds Limit 1];
        List<Opportunity> opps = [SELECT Id, IsQuoteAccepted__c FROM Opportunity WHERE Id In: oppIds Limit 1];

        for(Opportunity opp : opps){
            opp.IsQuoteAccepted__c = TRUE;
        }

        for(Opportunity opp : rejectedOpps){
            opp.IsQuoteAccepted__c = FALSE;
        }

        opps.addAll(rejectedOpps);
        if(!opps.isEmpty()){
            Update opps;
        }

        // Call the calculation logic
        new InclusiveHeaderPricingCalculation(newRecordsMap.keySet()).calculateInclusiveHeaderPricing();



    }*/




    
    
  public override void afterUpdate() {

    Set<Id> rejectedOppIds = new Set<Id>();
    Set<Id> oppIds = new Set<Id>();
    Set<Id> incoChangedQuoteIds = new Set<Id>();

    for (Quote q : newRecords) {

        Quote oldQ = (Quote) oldMap.get(q.Id);

        if (q.Status == 'Rejected' || q.Status == 'Denied (Internal)') {
            rejectedOppIds.add(q.OpportunityId);
        } else {
            oppIds.add(q.OpportunityId);
        }

        if (q.INCO_Terms__c != oldQ.INCO_Terms__c) {
            incoChangedQuoteIds.add(q.Id);
        }
    }
    List<Opportunity> rejectedOpps = [
        SELECT Id, IsQuoteAccepted__c FROM Opportunity WHERE Id IN :rejectedOppIds Limit 1
    ];
    List<Opportunity> opps = [
        SELECT Id, IsQuoteAccepted__c FROM Opportunity WHERE Id IN :oppIds Limit 1
    ];

    for (Opportunity opp : opps) opp.IsQuoteAccepted__c = true;
    for (Opportunity opp : rejectedOpps) opp.IsQuoteAccepted__c = false;

    opps.addAll(rejectedOpps);
    if (!opps.isEmpty()) update opps;

    new InclusiveHeaderPricingCalculation(newRecordsMap.keySet())
        .calculateInclusiveHeaderPricing();

    // üî• NEW ADDITION
    if (!incoChangedQuoteIds.isEmpty()) {
        repriceQuoteLineItems(incoChangedQuoteIds);
    }
}

private static Boolean isRepricing = false;

private void repriceQuoteLineItems(Set<Id> quoteIds) {

    if (isRepricing) return;
    isRepricing = true;

    System.debug('### Repricing started for Quotes: ' + quoteIds);

    // ===============================
    // Fetch Quotes
    // ===============================
    Map<Id, Quote> quoteMap = new Map<Id, Quote>([
        SELECT Id, INCO_Terms__c, OpportunityId, Opportunity.AccountId
        FROM Quote
        WHERE Id IN :quoteIds
    ]);

    // ===============================
    // Fetch Quote Line Items
    // ===============================
    List<QuoteLineItem> qlis = [
        SELECT Id, QuoteId, Product2Id, UnitPrice, ListPrice,
               From_Rate_Contract__c
        FROM QuoteLineItem
        WHERE QuoteId IN :quoteIds
    ];

    // ===============================
    // Collect Opportunity & Account Ids
    // ===============================
    Set<Id> oppIds = new Set<Id>();
    Set<Id> accIds = new Set<Id>();

    for (Quote q : quoteMap.values()) {
        if (q.OpportunityId != null) {
            oppIds.add(q.OpportunityId);
        }
        if (q.Opportunity.AccountId != null) {
            accIds.add(q.Opportunity.AccountId);
        }
    }

    if (oppIds.isEmpty() || accIds.isEmpty()) {
        isRepricing = false;
        return;
    }

    // ===============================
    // Fetch Opportunity Line Items (üî• SOURCE OF TRUTH)
    // ===============================
    Map<String, OpportunityLineItem> oliMap = new Map<String, OpportunityLineItem>();

    for (OpportunityLineItem oli : [
        SELECT OpportunityId, Product2Id, UnitPrice
        FROM OpportunityLineItem
        WHERE OpportunityId IN :oppIds
    ]) {
        String key = oli.OpportunityId + '-' + oli.Product2Id;
        oliMap.put(key, oli);
    }

    // ===============================
    // Fetch Rate Contracts
    // ===============================
    Date todayDate = Date.today();

    List<Rate_Contract__c> rcList = [
        SELECT Id, Account__c, INCO_Terms__c, CreatedDate
        FROM Rate_Contract__c
        WHERE Account__c IN :accIds
          AND Is_Active__c = true
          AND Rate_Contract_Approved__c = 'Approved'
          AND Start_Date__c <= :todayDate
          AND End_Date__c >= :todayDate
        ORDER BY CreatedDate DESC
    ];

    Map<String, List<Rate_Contract__c>> rcMap = new Map<String, List<Rate_Contract__c>>();
    Set<Id> rcIds = new Set<Id>();

    for (Rate_Contract__c rc : rcList) {
        String key = rc.Account__c + '-' + rc.INCO_Terms__c;

        if (!rcMap.containsKey(key)) {
            rcMap.put(key, new List<Rate_Contract__c>());
        }
        rcMap.get(key).add(rc);
        rcIds.add(rc.Id);
    }

    // ===============================
    // RC ‚Üí Product Map
    // ===============================
    Map<Id, Map<Id, Rate_Contract_Line_Item__c>> rcProductMap =
        new Map<Id, Map<Id, Rate_Contract_Line_Item__c>>();

    for (Rate_Contract_Line_Item__c rcLi : [
        SELECT Rate_Contract__c, Product__c, Offer_Price_INCO__c
        FROM Rate_Contract_Line_Item__c
        WHERE Rate_Contract__c IN :rcIds
    ]) {
        if (!rcProductMap.containsKey(rcLi.Rate_Contract__c)) {
            rcProductMap.put(rcLi.Rate_Contract__c, new Map<Id, Rate_Contract_Line_Item__c>());
        }
        rcProductMap.get(rcLi.Rate_Contract__c).put(rcLi.Product__c, rcLi);
    }

    // ===============================
    // Repricing Logic
    // ===============================
    List<QuoteLineItem> qliToUpdate = new List<QuoteLineItem>();

    for (QuoteLineItem qli : qlis) {

        Quote q = quoteMap.get(qli.QuoteId);
        if (q == null) continue;

        String rcKey = q.Opportunity.AccountId + '-' + q.INCO_Terms__c;
        String oliKey = q.OpportunityId + '-' + qli.Product2Id;

        Rate_Contract_Line_Item__c matchedRcLi;
        OpportunityLineItem oli = oliMap.get(oliKey);

        System.debug('--- QLI: ' + qli.Id);
        System.debug('Before ‚Üí UnitPrice=' + qli.UnitPrice + ', ListPrice=' + qli.ListPrice);

        // RC lookup
        if (rcMap.containsKey(rcKey)) {
            for (Rate_Contract__c rc : rcMap.get(rcKey)) {
                if (rcProductMap.containsKey(rc.Id)
                    && rcProductMap.get(rc.Id).containsKey(qli.Product2Id)) {

                    matchedRcLi = rcProductMap.get(rc.Id).get(qli.Product2Id);
                    break;
                }
            }
        }

        if (matchedRcLi != null && matchedRcLi.Offer_Price_INCO__c != null) {

            // ‚úÖ RC FOUND
            qli.UnitPrice = matchedRcLi.Offer_Price_INCO__c;
            qli.From_Rate_Contract__c = true;

            System.debug('RC FOUND ‚Üí Price=' + qli.UnitPrice);

        } else {

            // ‚ùå RC NOT FOUND ‚Üí RESTORE OPPORTUNITY PRICE
            if (oli != null) {
                qli.UnitPrice = oli.UnitPrice;
                qli.From_Rate_Contract__c = false;

                System.debug('NO RC ‚Üí Restored Opportunity Price=' + qli.UnitPrice);
            } else {
                qli.From_Rate_Contract__c = false;
                System.debug('NO RC ‚Üí No Opportunity Line found');
            }
        }

        qliToUpdate.add(qli);
    }

    if (!qliToUpdate.isEmpty()) {
        update qliToUpdate;
    }

    isRepricing = false;
    System.debug('### Repricing completed');
}
   
    
    
    
    
    
    
    
    
    
    










    

    public static void handleBankDetails(List<Quote> quoteList) {
        // Get all Bank Details metadata
        List<Bank_Detail__mdt> bankDetailRecords = [
            SELECT Label, BANK_NAME__c, BENEFICIARY_NAME__c, BANK_ADDRESS__c,
                ACCOUNT_NUMBER__c, IFSC_CODE__c, MICR_CODE__c, SWIFT_CODE__c,   
                Street__c, City__c, Zip_Postal_Code__c, State_Province_Code__c, Country_Territory_Code__c 
            FROM Bank_Detail__mdt
        ];

        System.debug('bankDetailRecords: '+ bankDetailRecords);

        // Map Label to Bank Detail
        Map<String, Bank_Detail__mdt> labelToBankDetailMap = new Map<String, Bank_Detail__mdt>();
        for (Bank_Detail__mdt bd : bankDetailRecords) {
            labelToBankDetailMap.put(bd.Label, bd);
        }

        System.debug('labelToBankDetailMap: '+ labelToBankDetailMap);

        // Loop through Quotes and populate Bank details
        for (Quote q : quoteList) {
            if (q.Bank__c != null) {
                Bank_Detail__mdt selectedBank = labelToBankDetailMap.get(q.Bank__c);
                if (selectedBank != null) {
                    q.Bank_Name__c = selectedBank.BANK_NAME__c;
                    q.Bank_Beneficiary_Name__c = selectedBank.BENEFICIARY_NAME__c;
                    q.Account_Number__c = selectedBank.ACCOUNT_NUMBER__c;
                    q.IFSC_Code__c = selectedBank.IFSC_CODE__c;
                    q.MICR_Code__c = selectedBank.MICR_CODE__c;
                    q.Swift_Code__c = selectedBank.SWIFT_CODE__c;
                    q.Bank_Address__City__s = selectedBank.City__c;
                    q.Bank_Address__PostalCode__s = selectedBank.Zip_Postal_Code__c;
                    q.Bank_Address__Street__s = selectedBank.Street__c;
                    q.Bank_Address__CountryCode__s = selectedBank.Country_Territory_Code__c;
                    q.Bank_Address__StateCode__s = selectedBank.State_Province_Code__c;
                }
            }
        }

        System.debug('quoteList: '+ quoteList);
    }


   public static void setIncoTermLocationFromAccount(List<Quote> quoteList) {
    System.debug('Inside setIncoTermLocationFromAccount on Quote Trigger Handler');

    Set<Id> opportunityIds = new Set<Id>();
    for (Quote q : quoteList) {
        if (q.OpportunityId != null) {
            opportunityIds.add(q.OpportunityId);
        }
    }

    System.debug('Opportunity Ids: ' + opportunityIds);

    if (!opportunityIds.isEmpty()) {
        Map<Id, Opportunity> oppMap = new Map<Id, Opportunity>(
            [SELECT Id, AccountId, Account.Incoterms_Location_1__c 
             FROM Opportunity 
             WHERE Id IN :opportunityIds]
        );

        for (Quote q : quoteList) {
            if (q.OpportunityId != null && oppMap.containsKey(q.OpportunityId)) {
                Opportunity opp = oppMap.get(q.OpportunityId);

                if (opp.Account != null) {
                    // Only update if Quote field is blank
                    if (String.isBlank(q.Incoterms_Location__c)) {
                        q.Incoterms_Location__c = opp.Account.Incoterms_Location_1__c;
                        System.debug('Quote Incoterm blank ‚Äî Setting from Account: ' + q.Incoterms_Location__c);
                    } else {
                        System.debug('Quote Incoterm already set ‚Äî Keeping quote value: ' + q.Incoterms_Location__c);
                    }
                }
            }
        }
    }
}



    public static void handleExporterAddress(List<Quote> quoteList) {
        // Fetch all Exporter Address metadata
        List<Exporter_Address__mdt> exporterAddressRecords = [
            SELECT Label, City__c, Country__c, Email__c, Exporter_Address__c, 
                Postal_Code__c, State__c, Street__c, Website__c,CIN__c
            FROM Exporter_Address__mdt
        ];
        
        System.debug('exporterAddressRecords: ' + exporterAddressRecords);

        // Map Label to Exporter Address metadata
        Map<String, Exporter_Address__mdt> labelToExporterAddressMap = new Map<String, Exporter_Address__mdt>();
        for (Exporter_Address__mdt ea : exporterAddressRecords) {
            labelToExporterAddressMap.put(ea.Label, ea);
        }

        System.debug('labelToExporterAddressMap: ' + labelToExporterAddressMap);

        // Loop through Quotes and populate Exporter Address based on Unit__c picklist
        for (Quote q : quoteList) {
            if (q.Unit__c != null) {
                Exporter_Address__mdt selectedAddress = labelToExporterAddressMap.get(q.Unit__c);
                if (selectedAddress != null) {
                    // Populate Address compound field
                    q.Exporter__Street__s     = selectedAddress.Street__c;
                    q.Exporter__City__s       = selectedAddress.City__c;
                    q.Exporter__PostalCode__s = selectedAddress.Postal_Code__c;
                    q.Exporter__StateCode__s  = selectedAddress.State__c;
                    q.Exporter__CountryCode__s= selectedAddress.Country__c;

                    // Optionally populate other related fields
                    q.Email   = selectedAddress.Email__c;
                    q.Website__c = selectedAddress.Website__c;
                    q.CIN__c=selectedAddress.CIN__c;
                    q.fieldVisibility__c = true;
                }
            }
        }

        System.debug('quoteList after exporter address population: ' + quoteList);
    }

	



	public static void setBillAndShipToFromAccount(List<Quote> quoteList, Map<Id, Quote> oldMap) {
    Set<Id> accIds = new Set<Id>();
    Set<Id> oppIds = new Set<Id>();
    Map<Id, Id> oppToAccountMap = new Map<Id, Id>();

    // Collect AccountIds directly or via Opportunity
    for (Quote q : quoteList) {
        Quote oldQ = oldMap != null ? oldMap.get(q.Id) : null;
        Boolean isAccountChanged = oldQ == null || (oldQ.AccountId != q.AccountId);

        if (isAccountChanged) {
            if (q.AccountId != null) {
                accIds.add(q.AccountId);
            } else if (q.OpportunityId != null) {
                oppIds.add(q.OpportunityId);
            }
        }
    }

    // üîπ If Quotes are created from Opportunity, fetch related Accounts
    if (!oppIds.isEmpty()) {
        for (Opportunity opp : [
            SELECT Id, AccountId 
            FROM Opportunity 
            WHERE Id IN :oppIds
        ]) {
            if (opp.AccountId != null) {
                accIds.add(opp.AccountId);
                oppToAccountMap.put(opp.Id, opp.AccountId);
            }
        }
    }

    if (accIds.isEmpty()) return;

    // üîπ Query Accounts with Customer Number
    Map<Id, Account> accMap = new Map<Id, Account>(
        [SELECT Id, Customer_Number__c FROM Account WHERE Id IN :accIds]
    );

    // üîπ Set Bill_To_Party__c and Ship_To_Party__c safely
    for (Quote q : quoteList) {
        Id accId = q.AccountId;

        // derive from Opportunity (only in-memory)
        if (accId == null && q.OpportunityId != null && oppToAccountMap.containsKey(q.OpportunityId)) {
            accId = oppToAccountMap.get(q.OpportunityId);
        }

        if (accId != null && accMap.containsKey(accId)) {
            Account acc = accMap.get(accId);
            if (acc.Customer_Number__c != null) {
                if (q.Bill_To_Party__c == null)
                    q.Bill_To_Party__c = acc.Customer_Number__c;
                if (q.Ship_To_Party__c == null)
                    q.Ship_To_Party__c = acc.Customer_Number__c;
            }
        }
    }
}



//WORKING CODE

/*public static void checkRateContractStatus(List<Quote> quoteList){

    Set<Id> quoteIds = new Set<Id>();

    for(Quote q : quoteList){
        if(q.Id != null){
            quoteIds.add(q.Id);
        }
    }

    if(quoteIds.isEmpty()){
        return;
    }

    // 1Ô∏è‚É£ Fetch Quote Line Items WITH Product RecordType DeveloperName
    List<QuoteLineItem> qliList = [
        SELECT Id, QuoteId, Product2Id, From_Rate_Contract__c,
               Product2.RecordType.DeveloperName
        FROM QuoteLineItem
        WHERE QuoteId IN :quoteIds
    ];

    // Map Quote ‚Üí QLI
    Map<Id, List<QuoteLineItem>> quoteToQLI = new Map<Id, List<QuoteLineItem>>();

    for(QuoteLineItem qli : qliList){
        if(!quoteToQLI.containsKey(qli.QuoteId)){
            quoteToQLI.put(qli.QuoteId, new List<QuoteLineItem>());
        }
        quoteToQLI.get(qli.QuoteId).add(qli);
    }

    // DeveloperName to ignore
    String ignoreRT = 'Alternate_BOM';

    // 2Ô∏è‚É£ Final Logic
    for(Quote q : quoteList){

        if(!quoteToQLI.containsKey(q.Id)){
            q.All_From_RC__c = false;
            continue;
        }

        Boolean allFromRC = true;

        for(QuoteLineItem qli : quoteToQLI.get(q.Id)){

            // üö´ Ignore RT: Alternate_BOM
            if(qli.Product2.RecordType.DeveloperName == ignoreRT){
                continue;
            }

            // Check normal products
            if(qli.From_Rate_Contract__c != true){
                allFromRC = false;
                break;
            }
        }

        q.All_From_RC__c = allFromRC;
    }
}


//NEW CODE

/*
public static void checkRateContractStatus(List<Quote> quoteList){

    Set<Id> quoteIds = new Set<Id>();
    for(Quote q : quoteList){
        if(q.Id != null){
            quoteIds.add(q.Id);
        }
    }
    if(quoteIds.isEmpty()) return;

    // Fetch QLIs with Product RT
    List<QuoteLineItem> qliList = [
        SELECT Id, QuoteId, Product2Id, From_Rate_Contract__c, From_NDP__c,
               Product2.RecordType.DeveloperName
        FROM QuoteLineItem
        WHERE QuoteId IN :quoteIds
    ];

    Map<Id, List<QuoteLineItem>> quoteToQLI = new Map<Id, List<QuoteLineItem>>();
    for(QuoteLineItem qli : qliList){
        if(!quoteToQLI.containsKey(qli.QuoteId)){
            quoteToQLI.put(qli.QuoteId, new List<QuoteLineItem>());
        }
        quoteToQLI.get(qli.QuoteId).add(qli);
    }

    String ignoreRT = 'Alternate_BOM';

    for(Quote q : quoteList){
        if(!quoteToQLI.containsKey(q.Id)){
            q.All_From_RC__c = false;
            continue;
        }

        Boolean allFromRC = true;

        for(QuoteLineItem qli : quoteToQLI.get(q.Id)){

            if(qli.Product2.RecordType.DeveloperName == ignoreRT) continue;

            // ‚úÖ Updated logic to handle all 4 scenarios
            if(qli.From_Rate_Contract__c == false && qli.From_NDP__c == false){
                allFromRC = false;
                break; // if any QLI fails, quote should be false
            }
        }

        q.All_From_RC__c = allFromRC;
    }
}*/
/* OLd CODe
public static void setGrandTotalInWords(List<Quote> quoteList) {

    for (Quote q : quoteList) {

        Decimal grandTotal =
            (q.Pricing_Type__c == 'Exclusive')
            ? (q.Exclusive_Header_Price_Total__c != null
                ? q.Exclusive_Header_Price_Total__c
                : 0)
            : (q.Inclusive_Header_Price_Total__c != null
                ? q.Inclusive_Header_Price_Total__c
                : 0);

        String amountInWords =
            NumberToWords.convertDecimalToWords(
                grandTotal,
                q.CurrencyIsoCode
            );

        q.Grand_Total_Amount_In_Words__c =
            q.CurrencyIsoCode + ' ' +
            grandTotal.setScale(2) +
            ' (' + amountInWords + ')';
    }
}
*/

public static void setGrandTotalInWords(List<Quote> quoteList) {
    for (Quote q : quoteList) {
        Decimal grandTotal =
            (q.Pricing_Type__c == 'Exclusive')
            ? (q.Exclusive_Header_Price_Total__c != null ? q.Exclusive_Header_Price_Total__c : 0)
            : (q.Inclusive_Header_Price_Total__c != null ? q.Inclusive_Header_Price_Total__c : 0);

        String amountInWords = NumberToWords.convertDecimalToWords(grandTotal, q.CurrencyIsoCode);

        // üîπ Set only the words (with currency code inside)
        q.Grand_Total_Amount_In_Words__c = amountInWords;
    }
}

/*
private static String getPicklistValueFromLabel(
    Schema.SObjectType sObjectType,
    String fieldApiName,
    String label
) {
    if (String.isBlank(label)) return null;

    Schema.DescribeFieldResult dfr =
        sObjectType.getDescribe().fields.getMap().get(fieldApiName).getDescribe();

    for (Schema.PicklistEntry pe : dfr.getPicklistValues()) {
        if (pe.getLabel().equalsIgnoreCase(label)) {
            return pe.getValue();
        }
    }
    return null;
}




public static void setBillAndShipToFromAccount1(List<Quote> quoteList) {
    if (quoteList == null || quoteList.isEmpty()) return;

    Set<Id> accIds = new Set<Id>();
    Set<Id> oppIds = new Set<Id>();
    Map<Id, Id> oppToAccountMap = new Map<Id, Id>();

    for (Quote q : quoteList) {
        if (q.AccountId != null) {
            accIds.add(q.AccountId);
        } else if (q.OpportunityId != null) {
            oppIds.add(q.OpportunityId);
        }
    }

    if (!oppIds.isEmpty()) {
        for (Opportunity opp : [
            SELECT Id, AccountId
            FROM Opportunity
            WHERE Id IN :oppIds
        ]) {
            if (opp.AccountId != null) {
                accIds.add(opp.AccountId);
                oppToAccountMap.put(opp.Id, opp.AccountId);
            }
        }
    }

    if (accIds.isEmpty()) return;

    Map<Id, Account> accountMap = new Map<Id, Account>([
        SELECT Id,
               BillingStreet,
               BillingCity,
               BillingPostalCode,
               BillingCountry,
               BillingState
        FROM Account
        WHERE Id IN :accIds
    ]);

    for (Quote q : quoteList) {
        Id accId = q.AccountId != null
            ? q.AccountId
            : oppToAccountMap.get(q.OpportunityId);

        if (accId == null || !accountMap.containsKey(accId)) continue;

        Account acc = accountMap.get(accId);

        q.Consignee__Street__s     = acc.BillingStreet;
        q.Consignee__City__s       = acc.BillingCity;
        q.Consignee__PostalCode__s = acc.BillingPostalCode;

        // üåç COUNTRY (Text ‚Üí ISO Picklist Value)
        String countryCode = getPicklistValueFromLabel(
            Quote.SObjectType,
            'Consignee__CountryCode__s',
            acc.BillingCountry
        );

        if (countryCode != null) {
            q.Consignee__CountryCode__s = countryCode;

            // üèõ STATE (dependent picklist)
            String stateCode = getPicklistValueFromLabel(
                Quote.SObjectType,
                'Consignee__StateCode__s',
                acc.BillingState
            );

            if (stateCode != null) {
                q.Consignee__StateCode__s = stateCode;
            }
        }
    }
}*/

//Ship to Party Name

public static void populateShipToPartyAndShippingName(
    List<Quote> quotes,
    Map<Id, Quote> oldMap
) {
    Set<Id> accountIds = new Set<Id>();

    // Collect Account Ids
    for (Quote q : quotes) {
        Boolean isChanged =
            oldMap == null || // insert
            (oldMap.containsKey(q.Id) &&
             q.Ship_To_Party_Name__c != oldMap.get(q.Id).Ship_To_Party_Name__c);

        if (q.Ship_To_Party_Name__c != null && isChanged) {
            // Use selected Ship To Party
            accountIds.add(q.Ship_To_Party_Name__c);
        } 
        else if (q.Ship_To_Party_Name__c == null && q.AccountId != null) {
            // Fallback to Quote's Account on insert
            accountIds.add(q.AccountId);
        }
    }

    if (accountIds.isEmpty()) return;

    // Fetch Account details
    Map<Id, Account> accMap = new Map<Id, Account>([
        SELECT Id,
               Customer_Number__c,
               Name,
               BillingStreet,
               BillingCity,
               BillingPostalCode,
               BillingState,
               BillingCountry,
               BillingLatitude,
               BillingLongitude,
               BillingGeocodeAccuracy
        FROM Account
        WHERE Id IN :accountIds
    ]);

    // Populate Quote fields
    for (Quote q : quotes) {
        // Determine which Account to use
        Id accId = q.Ship_To_Party_Name__c != null ? q.Ship_To_Party_Name__c : q.AccountId;

        if (accId == null || !accMap.containsKey(accId)) continue;

        Account acc = accMap.get(accId);

        // Fill Ship_To_Party_Name__c lookup if empty
        if (q.Ship_To_Party_Name__c == null) {
            q.Ship_To_Party_Name__c = acc.Id;
        }

        // Customer Number ‚Üí Ship To Party
        q.Ship_To_Party__c = acc.Customer_Number__c;

        // Account Name ‚Üí Shipping Name
        q.ShippingName = acc.Name;

        /* ================== ADDRESS LOGIC COMMENTED ==================

        // Buyer Address
        q.Buyer_Address__Street__s     = acc.BillingStreet;
        q.Buyer_Address__City__s       = acc.BillingCity;
        q.Buyer_Address__PostalCode__s = acc.BillingPostalCode;

        // Country picklist
        String countryCode = getPicklistValueFromLabel(
            Quote.SObjectType,
            'Buyer_Address__CountryCode__s',
            acc.BillingCountry
        );
        if (countryCode != null) {
            q.Buyer_Address__CountryCode__s = countryCode;

            // State picklist
            String stateCode = getPicklistValueFromLabel(
                Quote.SObjectType,
                'Buyer_Address__StateCode__s',
                acc.BillingState
            );
            if (stateCode != null) {
                q.Buyer_Address__StateCode__s = stateCode;
            }
        }

        // Optional Geo fields
        q.Buyer_Address__Latitude__s        = acc.BillingLatitude;
        q.Buyer_Address__Longitude__s       = acc.BillingLongitude;
        q.Buyer_Address__GeocodeAccuracy__s = acc.BillingGeocodeAccuracy;

        ================================================================ */
    }
}





private void setCombinedAddress(List<Quote> quoteList) {

    Set<Id> accountIds = new Set<Id>();
    for (Quote q : quoteList) {
        if (q.AccountId != null) {
            accountIds.add(q.AccountId);
        }
    }
    if (accountIds.isEmpty()) return;

    Map<Id, Account> accMap = new Map<Id, Account>([
        SELECT Id,
               Street__c,
               Street_2__c,
               Street_3__c,
               Street_4__c,
               House_Number__c,
               District__c,
               PO_Box_Postal_Code__c,
               City__c,
               Region_States_Province_County__r.Name,
               Country_Regions_Key__r.Name
        FROM Account
        WHERE Id IN :accountIds
    ]);

    for (Quote q : quoteList) {

        Account acc = accMap.get(q.AccountId);
        if (acc == null) continue;

        List<String> finalLines = new List<String>();

        // üîπ Line 1: House + Streets (ONE LINE)
        List<String> streetLine = new List<String>();
        if (String.isNotBlank(acc.House_Number__c)) streetLine.add(acc.House_Number__c);
        if (String.isNotBlank(acc.Street__c)) streetLine.add(acc.Street__c);
        if (String.isNotBlank(acc.Street_2__c)) streetLine.add(acc.Street_2__c);
        if (String.isNotBlank(acc.Street_3__c)) streetLine.add(acc.Street_3__c);
        if (String.isNotBlank(acc.Street_4__c)) streetLine.add(acc.Street_4__c);

        if (!streetLine.isEmpty()) {
            finalLines.add(String.join(streetLine, ', '));
        }

        // üîπ Line 2: District
        if (String.isNotBlank(acc.District__c)) {
            finalLines.add(acc.District__c);
        }

        // üîπ Line 3: City - Postal Code
        if (acc.City__c != null || acc.PO_Box_Postal_Code__c != null) {
            finalLines.add(
                (acc.City__c != null ? acc.City__c : '') +
                (acc.PO_Box_Postal_Code__c != null ? ' - ' + acc.PO_Box_Postal_Code__c : '')
            );
        }

        // üîπ Line 4: State
        if (acc.Region_States_Province_County__r != null) {
            finalLines.add(acc.Region_States_Province_County__r.Name);
        }

        // üîπ Line 5: Country
        if (acc.Country_Regions_Key__r != null) {
            finalLines.add(acc.Country_Regions_Key__r.Name);
        }

        // ‚úÖ Final formatted address
        q.Buyer_Combined_Address__c = String.join(finalLines, '\n');
    }
}

private void setBuyerCombinedAddress(List<Quote> quoteList, Map<Id, Quote> oldMap) {

    Set<Id> shipToAccountIds = new Set<Id>();

    // Collect Accounts where Ship_To_Party_Name__c is selected/changed or fallback to AccountId
    for (Quote q : quoteList) {
        Boolean isChanged = oldMap == null ||
            (oldMap.containsKey(q.Id) &&
             q.Ship_To_Party_Name__c != oldMap.get(q.Id).Ship_To_Party_Name__c);

        if (q.Ship_To_Party_Name__c != null && isChanged) {
            shipToAccountIds.add(q.Ship_To_Party_Name__c);
        } else if (q.Ship_To_Party_Name__c == null && q.AccountId != null) {
            shipToAccountIds.add(q.AccountId);
        }
    }

    if (shipToAccountIds.isEmpty()) return;

    // Fetch Account details
    Map<Id, Account> accMap = new Map<Id, Account>([
        SELECT Id,
               Street__c,
               Street_2__c,
               Street_3__c,
               Street_4__c,
               House_Number__c,
               District__c,
               PO_Box_Postal_Code__c,
               City__c,
               Region_States_Province_County__r.Name,
               Country_Regions_Key__r.Name
        FROM Account
        WHERE Id IN :shipToAccountIds
    ]);

    // Populate Combined Address
    for (Quote q : quoteList) {
        Id accId = q.Ship_To_Party_Name__c != null ? q.Ship_To_Party_Name__c : q.AccountId;
        if (accId == null || !accMap.containsKey(accId)) continue;

        Account acc = accMap.get(accId);

        List<String> finalLines = new List<String>();

        // üîπ Line 1 ‚Üí House + Streets (single line)
        List<String> streetLine = new List<String>();
        if (String.isNotBlank(acc.House_Number__c)) streetLine.add(acc.House_Number__c);
        if (String.isNotBlank(acc.Street__c)) streetLine.add(acc.Street__c);
        if (String.isNotBlank(acc.Street_2__c)) streetLine.add(acc.Street_2__c);
        if (String.isNotBlank(acc.Street_3__c)) streetLine.add(acc.Street_3__c);
        if (String.isNotBlank(acc.Street_4__c)) streetLine.add(acc.Street_4__c);

        if (!streetLine.isEmpty()) {
            finalLines.add(String.join(streetLine, ', '));
        }

        // üîπ Line 2 ‚Üí District
        if (String.isNotBlank(acc.District__c)) {
            finalLines.add(acc.District__c);
        }

        // üîπ Line 3 ‚Üí City - Postal Code
        if (acc.City__c != null || acc.PO_Box_Postal_Code__c != null) {
            finalLines.add(
                (acc.City__c != null ? acc.City__c : '') +
                (acc.PO_Box_Postal_Code__c != null ? ' - ' + acc.PO_Box_Postal_Code__c : '')
            );
        }

        // üîπ Line 4 ‚Üí State
        if (acc.Region_States_Province_County__r != null) {
            finalLines.add(acc.Region_States_Province_County__r.Name);
        }

        // üîπ Line 5 ‚Üí Country
        if (acc.Country_Regions_Key__r != null) {
            finalLines.add(acc.Country_Regions_Key__r.Name);
        }

        // ‚úÖ Final formatted address
        q.Combined_Address__c = String.join(finalLines, '\n');

        // Optional: auto-fill Ship To Party lookup
        if (q.Ship_To_Party_Name__c == null) {
            q.Ship_To_Party_Name__c = acc.Id;
        }
    }
}

}
